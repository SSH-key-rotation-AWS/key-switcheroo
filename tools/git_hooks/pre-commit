"""Pre Commit File"""
import asyncio
import subprocess
import sys
import black

def get_files():
    """Gets all py files staged for commit"""
    try:
        command = "git diff --name-only --cached --diff-filter=ACMRTUXB | grep '\.py$'"
        files = (
            subprocess.check_output(command, shell=True)
            .decode("utf-8")
            .strip()
            .replace("\n", " ")
        )
    except subprocess.CalledProcessError:
        print("no python file staged commits")
        sys.exit(0)
    return files


STAGED_FILES = get_files()

def run_black():
    """Async function, runs the black formatter on all staged py files"""
    print("Running Black...")
    listed_files = STAGED_FILES.split()

    for element in listed_files:
        with open(element, "r") as file:
            file_content = file.read()
        reformatted_content = black.format_str(file_content, mode=black.FileMode())
        print("Reformatted content" + "\n************************\n" +
reformatted_content +"\n"+"Changes Applied")
        with open(element, "w") as file:
            file.write(reformatted_content)


run_black()


async def run_pylint():
    """Async function, runs pylint on all staged py files, 
    and returns an eror if pylint finds errors."""
    print("Running PyLint...")
    task = await asyncio.create_subprocess_shell(
        "pylint " + STAGED_FILES,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    return_value_out,_ = await task.communicate()
    if task.returncode != 0:
        print("PyLint found errors, commit aborted")
        print("\n" + return_value_out.decode("utf-8"))
        return 2


async def run_pyright():
    """Async function, runs pyright on all staged py files, 
    and returns an eror if pyright finds errors."""
    print("Running PyRight...")
    task = await asyncio.create_subprocess_shell(
        "pyright " + STAGED_FILES,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    return_value_out,_ = await task.communicate()
    if task.returncode != 0:
        print("PyRight found errors, commit aborted")
        print("\n" + return_value_out.decode("utf-8"))
        return 1


async def main():
    """gathers all functions, and runs them asyncrionsly"""
    pyright_task = asyncio.create_task(run_pyright())
    pylint_task = asyncio.create_task(run_pylint())
    results = await asyncio.gather(pyright_task, pylint_task)
    if 1 in results or 2 in results:
        sys.exit(1)
    print("All tests passed, files will proceed to commit")
    sys.exit(0)


asyncio.run(main())
